pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
--bitpack
--by mabbees

--[[
 pack 4 1-bit spritesheets
 into 1 4-bit spritesheet
--]]

function _init()
	draw_encoded = false
	spr_mask = 1
	write_spritesheet(do_composite())
	
	menuitem(1, "export", store_spritesheet)
end

function _update60()	
	if btnp(⬅️) then
		spr_mask -= 1
	end
	if btnp(➡️) then
		spr_mask += 1
	end
	spr_mask = mid(1,spr_mask,4)
	
	draw_encoded = btn(❎)
end

function _draw()
	cls()
	if draw_encoded then
		spr(0,0,0,128,128)
	else
		draw_1bit_spr(spr_mask,0,0,0,128,128)
	end
end


function do_composite()	
	load_spritesheet("../sprites/ui_sprites.p8")
	local ss1 = read_spritesheet()
	
	load_spritesheet("../sprites/character_sprites.p8")
	local ss2 = read_spritesheet()
	
	load_spritesheet("../sprites/battle_sprites.p8")
	local ss3 = read_spritesheet()
	
	load_spritesheet("../sprites/title_sprites.p8")
	local ss4 = read_spritesheet()
	
	return merge_sheets(
		to_1bit(ss1),
		to_1bit(ss2),
		to_1bit(ss3),
		to_1bit(ss4)
	)
end
-->8
-- i/o

-- load spritesheet from cart
function load_spritesheet(cart)
	reload(0x0000, 0x0000, 0x2000, cart)
end

-- store the spritesheet to the
-- cart
function store_spritesheet()
	cstore()
end

-- read spritesheet into
-- an array of bytes
function read_spritesheet()
	return pack(peek(0x0000, 0x2000))
end

-- write an array of bytes
-- to the spritesheet memory
function write_spritesheet(s)
	return poke(0x0000, unpack(s))
end
-->8
-- encoding

-- split a byte into 2 nybbles
function byte_to_nybbles(b)
	return
		(b >>> 0) & 0b1111,
		(b >>> 4) & 0b1111
end

-- join two nybbles into a byte
function nybbles_to_byte(n1,n2)
	return (n1 << 0) | (n2 << 4)
end

-- convert a 4-bit spritesheet
-- to a 1-bit spritesheet
-- black pixels set to 0
-- other pixels are set to 1
function to_1bit(ss)
	local ret = {}
	for i=1,#ss do
		local n1,n2 = byte_to_nybbles(ss[i])
		ret[i] = nybbles_to_byte(
			n1 == 0 and 0b0000 or 0b0001,
			n2 == 0 and 0b0000 or 0b0001
		)
	end
	return ret
end

-- merge 4 1-bit sheets
-- * s1 : a 1-bit spritesheet
-- * s2 : a 1-bit spritesheet
-- * s3 : a 1-bit spritesheet
-- * s4 : a 1-bit spritesheet
function merge_sheets(s1,s2,s3,s4)
	local ret = {}
	for i=1,#s1 do
		ret[i] = (s1[i] << 0)
		       | (s2[i] << 1)
		       | (s3[i] << 2)
		       | (s4[i] << 3)
	end
	return ret
end
-->8
-- decoding

-- create a 1-bit palette that
-- sets masked bits to a solid
-- color
-- * b: the bitmask
-- * c: the color
function palette_1bit(b,c)
	local ret = {}
	for i=0,15 do
		ret[i] = (i & b == 0)
			and 0
			or  c
	end
	return ret
end

palettes = {
	palette_1bit(0b0001,7),
	palette_1bit(0b0010,7),
	palette_1bit(0b0100,7),
	palette_1bit(0b1000,7),
}

-- draw a sprite from a 4-in-1
-- spritesheet, using index b
function draw_1bit_spr(b,n,x,y,w,h)
	w = w or 1
	h = h or 1
	pal(palettes[b])
	spr(n,x,y,w,h)
	pal()
end
__gfx__
00000000000004405411110100000000011331100001000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000446646640000000000000111133110011100000000000000000000000000000000000000000000000000000000000000000000000000000000000
00900900040666667664000100000000110002310001000000004404400000000000000000000000000000000000000400000000000000000000000000000000
00099004470666663622400100000000130200330001000000444444440000000002202200000000000000000000444400000000000000200000000000000000
00099046771777375640600100000020333331132023200040444444444000000222222220000000000000004444444000000000000222200000000000000000
00900966630662467660600100002220233333102203224440444440400400020222222222000000000044444444000000000002222222000000000000000000
00000026200264666660200000022220222022200023046440444044440402220222220200200000444444440000000000022222222000000000000000000000
00000002000026667671110100022200220222220221244600440444440422220226462220204444444400000000000222222220000000000000000000000000
00110110001107766620000000002040022222220202226000044444440022200220666264644444002220000002222222200000000000000000000000000000
01001005454012676200000000000440002222220000222000004444440002000462666264440000000222022222222000000000000000000000000000000000
01010547672400232000000000004400002222200020000000004444400044440442666220000000220222022220000000000000000000000000000000000000
01055767270640010000000000046222000222000466644444000444044444440006666200022220220222000000000000000000000000000000000000000000
00567676065264104000000000662220200000444666644440400000266666622444662022222220002222000000000000000000000000000000000000000000
04676762466167446000000006622020220040264666444440440222266662220200000022222200222220000000000000000000000000000000000000000000
06667620666436626400000066220222022446226662440044064026266222220220000022220000000000000000000000000000000000000000000000000000
46662204666206606604440462202222202646222222004444626046260220022022002022000000000000000000000000000000000000000000000000000000
66620046666046602600440422220222002200222220004444266044440002222202022020000000000000000000000000000000000000000000000000000000
66600066662066604640044062200022022200002200444440444004400002222022022220000000000000000000000000000000000000000000000000000000
66200066660066206620404462220002022200000044444440444044400222220222002200000000000000000000000000000000000000000000000000000000
22440466660466006604440442220200022020000444444400440040022222220222022200000000000000000000000000000000000000000000000000000000
04620666620222042604400400220220222020000444444404440040222222200220020000000000000000000000000000000000000000000000000000000000
02204666204444024204404000002220000022000044400000000400222222202220020000000000000000000000000000000000000000000000000000000000
00002262046666406000040000220200222002000000004444440040022200000000200000000000000000000000000000000000000000000000000000000000
00000020466226642000000000022002222202004404444444444040000002222220020000000000000000000000000000000000000000000000000000000000
00000444662046664000000000000222002220044444444440044406602222222222020000000000000000000000000000000000000000000000000000000000
00004666620066666400000000222220022222444444400000000466662222220022202200000000000000000000000000000000000000000000000000000000
00046666200026666600000000222220022266644440000000000266662200000000222220000000000000000000000000000000000000000000000000000000
00066666000046666200000002222200026666644000000000022266660000000000022220000000000000000000000000000000000000000000000000000000
00466662000066662000000002222200046666400000000002222266440000000000022220000000000000000000000000000000000000000000000000000000
00266620000466620000000022222000006662000000000022222644400000000000022220000000000000000000000000000000000000000000000000000000
00466640000666644000000002220000066664000000000002220444444000000000222200000000000000000000000000000000000000000000000000000000
00222220000222222000000022222000022222200000000022222000000000000000222222000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000022000444440000000000000000004444444400000000000000000000220000000000000000022200200000000000
00000000000000000000000000000000000264444444444440000000000000000000044444400000000000000002200000000000000002002002022000000000
00000002222220000000000000000000002200000000444444400000000000000000000004444000000000020022000220000000000002200020000200022200
00000022222222000000000000000000022002000000004444440002222220000000000000044440000000000220000002000000000020022222000020200020
00000022222222000000000000000000220022220000000444444422222222000000000000000444000000002200220002002220000020200000222020000020
00000002222222020000000000022202200222220000000444444466222222000000000000400044400000022000002222020002000002002222000220000200
00000020000000200000000000222022002222220200000044444446622222020000000000044404442220220022220002000002000000022222220000002000
00000022222220020000044446002200000000002000000044444464440000200000000000000444466202200222222200000020000000022222200000200020
00000022222220000000000464460220022222200200000044444466662220020000000000000044644620000222222000000200000000002222200000222220
00000002222200222000000006666020022222200000000044444466666220000000000000040004446462200022222000020446000000000222000200022200
00000000222000022220000002664400022222002200000044444446666200000000000000000444466646200002220020022666444400020000020022000020
00000000000000220222200000044640002220000222000064644444666000000000000000000044466644400200000002002220444444660022022022202220
00000002000022200202220000066640000000002022220464646464444000222020202000000004444444022002202202200002000046664666020022222220
00000000022222220202022000446460000000222020222446464464444002222222222222000004444660222022202002220222000000024664664620222220
00000022002222222002000204444620220022222020206644446666444022222020202020020000444622002022022022222222000002200220664664662200
00000000020022200000220244446202022022222200006444444446640222220020202000222000444022220022022022022222000002220220642264446440
00000022202222222000006644440020202000222000264644444464422222000000000000222004440022222022020222022220000002020222402264004444
00000000000002222204666444400220220022222022464644444444222222222200000000000044400002202022200222000200000000020062002664044440
00000202202222226444446640000022000000022026446444444440000022222000000000000444000000002002200222000000000000020000006662044400
00000000000044666664620000000000000022222066446444444400002222222222000000004440000000002000000222200000000000020022246622444000
00000022444666666000022000000000000000002444464444444000000000222220000000044400000000002002220222200000000000022022640226640000
00444444444440000000000000000000000002266444444444400000000022222222220000444000000000022202222022220000000000220062222066620000
00000000002000002220000000000000000004444444444440000000002000000022200004440000000000022022222202222000000000220222222466222000
00000000222222222222000000000000000664444466644000000000022220000000000044400000000000222022022220222200000002220220226642222000
00000000222200222222000000000000046666446666620000000002222222222000002644000000000000222022022220222200000002220222466202222000
00000002222220222222000000000000466666666622220000000022222200022222226660000000000002220222022220222200000002220266462202222000
00000002222200022222200000000000666664402222220000000022222000000002266622000000000002202220002220222000000002246664022202220000
00000000000000022222220000000000444000002222222000000000000000000000466222220000000000202220000200000044444444646220002000000000
00000000222000000222220000000000022200000022222000000002220000000000440222222200000000020002000022222000000000020002000222220000
00000000000000000020002000000000000000000002000200000000000000000000000002000020000000020002000000200200000000020002000002002000
00000000020000000002220000000000002000000000222000000000200000000000000000022200000000200002000002000200000000200002000020002000
00000000020000000022222000000000002000000002222200000000200000000000000000222220000000222222000002222000000000222220000022220000
00000002222000000000000000000000000000022220000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000022622200000000000000000000000000002222000000000000000000000000000040000000000000000000000000000000000000000000990000000000
00000222222220000000000000000000000002202222200000000000000000002222000000000000000000000000002220020000000000000000990000000000
00000222222220000000000000000000000022002222200000000000000000022222200000000000000000000000200200202200000002220000990000000000
00000002000220000000000000000000000220020002200000000000000000222222bbd999999999999999999999bb999b9999b99999b999b999990000000000
000002022033111111000000000000000022000220220000000000000000002222bb2200999d000000009999999b90222220999b999990002000990000009900
000002222323030450111000000000000220022226620200000000000040000029002299990400000099999999920200009bbb9b9990000200009999999d9990
0000002223211335332301000000000022000022266002202222000004400020bb9bb999999dd99999999d999999b99bbbb999bb999999b99999999999999990
00000002721133773333201000022202200000022640222222222000444400222b222020040044222000000000000022222220000000200020009999999999d0
000022214513317333333105442220220000222000422022222220044400000222bb002220426622222040000000002222220000000022222000990400009900
000222321733133333333354560022000002222202260222222222444000000022209bbbbbbdbfbbbbbbb999bbbb999bbbbb999999999bbb9999994000000000
002223202231333332226731210202220022222022242222222226642222022200002202222266622226220022222000222000200222000420009d0044400000
00223233312322232173323103222022022222222022222220226620222222222022202222222662002022000222002000002002222220262000d94440000000
00232333313233323313332303220002022222222022622222066222022222220222022222222600000220000000022002202220222222222044dd4400000000
00232132233233323201332310100200022220222222222222042222000222222202222222220000000000000000222022202202222222222004400000000000
00012123323233320112332310120000222220622222222200422222000002222202222222200000000000000000002022202066200222220000000000000000
00210333333633301333332111012222222200666222222006222220000000222220222222244000400000000000000022202022224002240000000000000000
00001213332733352333321111010022220000026622222022222200000000002222222222990000000000400000002022202022222000000000000000000000
00021200227723217022210111010000200000002222222020222000000000000222222222b90000004000004000002022202022222244000000000000000000
00001211337732311753310111010000000000002222222002022000000044000022222222bb0000004400000040002002220202226662000000400000000000
00212101176732330177110111101000000000000222222244664400000000000000222222b9b999999dd999999999b9999999b9bfffbbb9999999d999990000
002101121554010031155001111010000000000200000000204444000000000000bb0000009922004004dd99999990020022bd999bfbb22220000099d9009900
00301131033333331131450111110100000000200662222200204400000000000b99bbbbbbbb00200099d9999990000202fbbbb999b222622200999900000090
0010131100101010102055411111010004000200440000000020000000000000299999999999999b9999999d999999bb9bbbbbbbf99bbbbbb999999999999999
00010200110000000013045411110100000002000000000000020000000000002999999999990006000000004000000002220026220026222000000000000090
00003111003311111102004540001000000020000022000000020000000000020099022222b90004200000000400000222222040222202220000000000009900
000020000020222000002004551100000000200000202220000020000000002000002000009bb9999b999d9999d999bbbbb99d99999bdbb99b99999999990000
00002000020000222222200400000000000020000200002222222000000000222220200000990220222200000000002222000000000002002222000000000000
00000222200040000000000000000000000002222000000000000000000000000002000000990002000000000000002222000000000000022222220000000000
00000000000040000222220000000000000000000000000002222200000000222200000000990000022222400000002000200000000000000220002000000000
00000222200000000022220000000000000002222000000000222200000000022220000000000000002222000000002000200000000000000200002000000000
00002222200000000222222000000000000022222000000002222220000002222220000000000000022222200000022222200000000000000022222000000000
00000000000000000000000000000000444444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000004444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000002222000000000000000000000020022000444400000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000022222200000000000000000000200220000004444000000002222000000000000000000000000000000000000000000000000000000000000000000000
00000222222220000000000000000002002200200000044400000022222200000000000000000000000000000000000000000000000000000000000000000000
00000222222220000000000000000000022002200000004440000222222220000000000000000000000000000000000000000000000000000000000000000000
00000222222220000000000000000000220022200000000444000222222220000000000000000000000000000000000000000000000000000000000000000000
00000222222264444444440000000002200222200000000044400222222220000000000000000000000000000000000000000000000000000000000000000000
00000022222200000000000000022022002222000000000004440222222220000000000000000000000000000000000000000000000000000000000000000000
00000022222000000000000000220220022220000000000000444022222200000000000000000000000000000000000000000000000000000000000000000000
00000002220002202200000000022000022200022000000000044422222000000000000000000000000000000000000000020000000000000000000000000000
00000004444446662220000000202220000000022020000022224442220002202200000000000000000000000000000000220000022000000000000000000000
00000002002202222222000000220202220022022222000022226644000002222222222000000000000000000000000002200000002200000000000000000000
00000022022202222222200000200002220222022222200002222466002202222222222002000000000000000000000022000000000220000000000000000000
44444666646466646666664444446466220220222222220000022666422202222222220022220000000000000000000220000000000022000000000000000000
44444666646466664466666444666664220202220222222000000266602022200022020222222000000000000000002200000000000002200000000000000000
00000022220022222002200000022222022002222002222200000066642022222200000000222000000000000000022000000000000000220000000000000000
00000220222222222000002200002222022222222200220000000026660022222200000000000000000000000000220000000000000000022000000000000000
00000022002222244444466640002200000222220000002200000006662222222220000000000000000000000002200000000000000000002200000000000000
00000022000000000000022200000000000000000000022200000004666222222220000000000000000000000022000000000000000000000220000000000000
00000020200000000200222200000000020000000000022200000004446222222200220000000000000000000220000000000000000000000022000000000000
00000002220000022220022000000000222000002200222200000000444022200002222220000000000000002200000000000000000000000002200000000000
00000002222222222222000000000000222222222220022000000000464400000222222200000000000000022000000000000000000000000000220000000000
00000000022222222220000000000000002222222222000000000000466600022222220000000000000000220000000000000000000000000000022000000000
00000002000266664440000000000000200022222000000000000002444622222220000220000000022202200000000000000000000000000000002202220000
00000022220000000222000000000002222000000022200000000022664422222002222222200000002202000000000000000000000000000000000220222000
00000022222000002222200000000002222200000222200000000022666400000000022222220000000220200000000000000000000000000000000002200200
00000002222000002222200000000002222000002222200000000022664440000000000222222200002022200000000000000000000000000000000222020020
00000000222000000222220000000000222000000222220000000002664440000000000002222220022202200000000000000000000000000000000220222200
00000002222200000022222000000002222200000022222000000022266440000000000000022222022002000000000000000000000000000000000200022200
00000022222200000222222000000022222200000222222000000222266444000000000000222222022020000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000
